name: Metrics Contract Guard

on:
  pull_request:
    branches: ["main"]
    paths:
      - 'specs/**/*.yaml'
      - 'specs/**/*.yml'
      - 'specs/**/*.json'
      - 'core/**/*.py'
      - 'core/**/*.ts'
      - 'core/**/*.go'
      - 'core/**/*.rs'
      - 'gateway/**/*.py'
      - 'gateway/**/*.ts'
      - 'gateway/**/*.go'
      - 'gateway/**/*.rs'
      - 'worker/**/*.py'
      - 'worker/**/*.ts'
      - 'worker/**/*.go'
      - 'worker/**/*.rs'
      - 'tools/metrics_contract_check.py'
      - 'monitoring/**'
  push:
    branches: ["main"]
    paths:
      - 'specs/**/*.yaml'
      - 'specs/**/*.yml'
      - 'specs/**/*.json'
      - 'core/**/*.py'
      - 'core/**/*.ts'
      - 'core/**/*.go'
      - 'core/**/*.rs'
      - 'gateway/**/*.py'
      - 'gateway/**/*.ts'
      - 'gateway/**/*.go'
      - 'gateway/**/*.rs'
      - 'worker/**/*.py'
      - 'worker/**/*.ts'
      - 'worker/**/*.go'
      - 'worker/**/*.rs'
      - 'tools/metrics_contract_check.py'
      - 'monitoring/**'

concurrency:
  group: metrics-contract-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      run_metrics_guard: ${{ steps.filter.outputs.run_metrics_guard }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Detect metrics-relevant changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            run_metrics_guard:
              - 'specs/**/*.yaml'
              - 'specs/**/*.yml'
              - 'specs/**/*.json'
              - 'core/**/*.py'
              - 'core/**/*.ts'
              - 'core/**/*.go'
              - 'core/**/*.rs'
              - 'gateway/**/*.py'
              - 'gateway/**/*.ts'
              - 'gateway/**/*.go'
              - 'gateway/**/*.rs'
              - 'worker/**/*.py'
              - 'worker/**/*.ts'
              - 'worker/**/*.go'
              - 'worker/**/*.rs'
              - 'tools/metrics_contract_check.py'
              - 'monitoring/**'

  metrics-contract:
    name: Verify Prometheus metrics contract (static)
    needs: [changes]
    if: ${{ needs.changes.outputs.run_metrics_guard == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run metrics contract check
        run: |
          python tools/metrics_contract_check.py

  skip:
    name: metrics-contract-skip
    needs: [changes]
    if: ${{ needs.changes.outputs.run_metrics_guard != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - run: echo "No source/schema changes detected; skipping metrics contract guard."
