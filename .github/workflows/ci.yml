name: ATR Core CI (Python Package + Sidecar)

on:
  pull_request:
    branches: ["main"]
    paths:
      - 'specs/**/*.yaml'
      - 'specs/**/*.yml'
      - 'specs/**/*.json'
      - 'core/**/*.py'
      - 'core/**/*.ts'
      - 'core/**/*.go'
      - 'core/**/*.rs'
      - 'gateway/**/*.py'
      - 'gateway/**/*.ts'
      - 'gateway/**/*.go'
      - 'gateway/**/*.rs'
      - 'worker/**/*.py'
      - 'worker/**/*.ts'
      - 'worker/**/*.go'
      - 'worker/**/*.rs'
  push:
    branches: ["main"]
    paths:
      - 'specs/**/*.yaml'
      - 'specs/**/*.yml'
      - 'specs/**/*.json'
      - 'core/**/*.py'
      - 'core/**/*.ts'
      - 'core/**/*.go'
      - 'core/**/*.rs'
      - 'gateway/**/*.py'
      - 'gateway/**/*.ts'
      - 'gateway/**/*.go'
      - 'gateway/**/*.rs'
      - 'worker/**/*.py'
      - 'worker/**/*.ts'
      - 'worker/**/*.go'
      - 'worker/**/*.rs'

concurrency:
  group: atr-core-build-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      python_related: ${{ steps.filter.outputs.python_related }}
      rust_related: ${{ steps.filter.outputs.rust_related }}
      schema_related: ${{ steps.filter.outputs.schema_related }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            python_related:
              - 'core/**/*.py'
              - 'gateway/**/*.py'
              - 'worker/**/*.py'
              - 'specs/**/*.yaml'
              - 'specs/**/*.yml'
              - 'specs/**/*.json'
            rust_related:
              - 'core/**/*.rs'
              - 'gateway/**/*.rs'
              - 'worker/**/*.rs'
              - 'specs/**/*.yaml'
              - 'specs/**/*.yml'
              - 'specs/**/*.json'
            schema_related:
              - 'specs/**/AkashicEnvelope*.json'
              - 'specs/**/akashicenvelope*.json'
              - 'specs/**/ruleset*.json'
              - 'specs/**/ruleset*.yaml'
              - 'specs/**/ruleset*.yml'
              - 'specs/**/benchmark_contract*.yaml'
              - 'specs/**/benchmark_contract*.yml'

  python:
    runs-on: ubuntu-latest
    needs: [changes]
    if: ${{ needs.changes.outputs.python_related == 'true' || needs.changes.outputs.schema_related == 'true' }}
    defaults:
      run:
        working-directory: python
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .[test]
      - name: Run tests
        run: pytest -q atr_core/tests

  rust:
    runs-on: ubuntu-latest
    needs: [changes]
    if: ${{ needs.changes.outputs.rust_related == 'true' || needs.changes.outputs.schema_related == 'true' }}
    defaults:
      run:
        working-directory: sidecar/atb-et
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Check sidecar
        run: cargo check

  docs-only:
    runs-on: ubuntu-latest
    needs: [changes]
    if: ${{ needs.changes.outputs.python_related != 'true' && needs.changes.outputs.rust_related != 'true' && needs.changes.outputs.schema_related != 'true' }}
    steps:
      - run: echo "No source/schema changes detected; skipping package and sidecar checks."
