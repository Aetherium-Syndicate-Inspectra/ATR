syntax = "proto3";

package atr.transport.v1;

option go_package = "atr/transport/v1";
option java_multiple_files = true;

// ======================================================
// ENUMS
// ======================================================

enum SubmitMode {
  SUBMIT_MODE_UNSPECIFIED = 0;
  INLINE_ONLY = 1;
  ALLOW_ARENA_REF = 2;
  ALLOW_SHM_REF = 3;
}

enum Decision {
  DECISION_UNSPECIFIED = 0;
  ALLOW = 1;
  DROP = 2;
  THROTTLED = 3;
}

// ======================================================
// CORE PACKET MESSAGE (CONTROL PLANE â†’ DATA PLANE)
// ======================================================

message TachyonPacket {
  uint64 flags = 1;
  uint32 topic_id = 2;
  uint32 sender_id = 3;

  // Fixed 48 bytes payload.
  bytes inline_data = 4;
  // MUST be <= 48 bytes if used.

  // Arena reference.
  ArenaRef arena_ref = 5;

  // Shared memory reference.
  ShmRef shm_ref = 6;
}

message ArenaRef {
  uint32 arena_id = 1;
  uint64 offset = 2;
  uint32 length = 3;
  uint64 checksum = 4;
}

message ShmRef {
  uint64 segment_id = 1;
  uint64 offset = 2;
  uint32 length = 3;
  uint64 checksum = 4;
}

// ======================================================
// BATCH SUBMIT
// ======================================================

message BatchSubmitRequest {
  uint64 request_id = 1;

  // Optional governance override flags.
  bool governance_required = 2;

  // Preferred submission mode.
  SubmitMode mode = 3;

  // Micro-batch.
  repeated TachyonPacket packets = 4;

  // Timestamp at control plane.
  uint64 submit_timestamp_ns = 5;
}

message BatchSubmitResponse {
  uint64 request_id = 1;

  uint32 accepted = 2;
  uint32 dropped = 3;
  uint32 throttled = 4;

  repeated PacketResult results = 5;

  uint64 processing_time_ns = 6;
}

message PacketResult {
  uint32 index = 1;
  Decision decision = 2;
}

// ======================================================
// RULE UPDATE (RCU)
// ======================================================

message GovernanceUpdateRequest {
  uint64 version = 1;

  repeated TopicRateLimit topic_limits = 2;
  repeated SenderQuota sender_quotas = 3;
  repeated uint32 allowlist_topics = 4;
}

message TopicRateLimit {
  uint32 topic_id = 1;
  uint64 capacity = 2;
  uint64 refill_rate = 3;
}

message SenderQuota {
  uint32 sender_id = 1;
  uint32 max_in_flight = 2;
}

message GovernanceUpdateResponse {
  uint64 version = 1;
  bool success = 2;
  string error_message = 3;
}

// ======================================================
// SERVICE DEFINITION
// ======================================================

service ATRTransport {
  // High-performance batch submit.
  rpc SubmitBatch(BatchSubmitRequest) returns (BatchSubmitResponse);

  // Governance RCU swap.
  rpc UpdateGovernance(GovernanceUpdateRequest) returns (GovernanceUpdateResponse);
}
